version: 2.1

###################################################################################################
# orbs:
#   awscli: aws/cli@3.1.3
#   awseks: aws/eks@3.1.3
#   kube: kubernetes/kube@1.2.1


###################################################################################################
jobs: 

  build: 
    docker: 
      - image: alpine:latest
    steps: 
      # since we are using a simple html to represent the app no additional build steps needed
      - checkout

  lint:
    docker:
      - image: cimg/node:18.10.0
    steps:
      - checkout
      - run:
          name: Install linting dependencies (hadolint, tidy)
          command: |
            # Install hadolint
            sudo wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.10.0/hadolint-Linux-x86_64 
            sudo chmod +x /bin/hadolint
            sudo apt install tidy
      - run:
          name: lint sourcecode (html)
          command: tidy -e src/*.html
      - run:
          name: lint Dockerfile
          command: hadolint Dockerfile
            
      
  build-and-publish-image:
    docker:
      - image: docker:stable
        auth:
          username: $DOCKERHUB_LOGIN
          password: $DOCKERHUB_ACCESS_TOKEN
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: build and publish 
          command: |
            docker login -u $DOCKERHUB_LOGIN -p $DOCKERHUB_ACCESS_TOKEN
            docker build -t aobri/cloud-devops-capstone:latest  . 
            docker push aobri/cloud-devops-capstone:latest



###################################################################################################
  # deploy-infra:

  # configure-infra:

  # switch-traffic-to-blue:

  # deploy-green:

  # test-green:

  # switch-traffic-to-green:

  # deploy-blue:

  # cleanup:






###################################################################################################
workflows: 
  default:
    jobs:
      - build
      - lint:
          requires: [build]
      - build-and-publish-image:
          requires: [lint]
